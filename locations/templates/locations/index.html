<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Báº£n Ä‘á»“ Ä‚n ChÆ¡i</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        
        /* NÃºt thÃªm Ä‘á»‹a Ä‘iá»ƒm ná»•i trÃªn map */
        .btn-add {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: #007bff; color: white; padding: 10px 20px;
            text-decoration: none; font-weight: bold; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .btn-add:hover { background: #0056b3; }

        /* Style cho nÃºt chá»‰ Ä‘Æ°á»ng trong popup */
        .btn-route {
            background: #28a745; color: white; border: none;
            padding: 5px 10px; border-radius: 3px; cursor: pointer;
            margin-top: 5px; width: 100%;
        }
    </style>
</head>
<body>

    <a href="{% url 'add_location' %}" class="btn-add">+ ThÃªm Ä‘á»‹a Ä‘iá»ƒm</a>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // Khá»Ÿi táº¡o báº£n Ä‘á»“
        var map = L.map('map').setView([10.762622, 106.660172], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Biáº¿n lÆ°u Ä‘iá»u khiá»ƒn dáº«n Ä‘Æ°á»ng (Ä‘á»ƒ xÃ³a Ä‘i váº½ láº¡i khi chá»n Ä‘iá»ƒm khÃ¡c)
        var routingControl = null;

        // Dá»¯ liá»‡u tá»« Django
        var data = {{ locations_json|safe }};

        // HÃ m xá»­ lÃ½ khi báº¥m nÃºt "Chá»‰ Ä‘Æ°á»ng"
        window.startNavigation = function(destLat, destLon) {
            // 1. Há»i trÃ¬nh duyá»‡t láº¥y vá»‹ trÃ­ hiá»‡n táº¡i
            if (navigator.geolocation) {
                map.closePopup(); // ÄÃ³ng popup cho Ä‘á»¡ vÆ°á»›ng
                alert("Äang tÃ¬m vá»‹ trÃ­ cá»§a báº¡n... Vui lÃ²ng Ä‘á»£i 1 chÃºt!");

                navigator.geolocation.getCurrentPosition(function(position) {
                    var userLat = position.coords.latitude;
                    var userLon = position.coords.longitude;

                    // 2. XÃ³a Ä‘Æ°á»ng dáº«n cÅ© (náº¿u cÃ³)
                    if (routingControl) {
                        map.removeControl(routingControl);
                    }

                    // 3. Táº¡o Ä‘Æ°á»ng dáº«n má»›i tá»« User -> Äiá»ƒm Ä‘áº¿n
                    routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(userLat, userLon),  // Äiá»ƒm Ä‘i (Vá»‹ trÃ­ cá»§a báº¡n)
                            L.latLng(destLat, destLon)   // Äiá»ƒm Ä‘áº¿n (QuÃ¡n Äƒn)
                        ],
                        routeWhileDragging: true,
                        language: 'vi', // Tiáº¿ng Viá»‡t (náº¿u há»— trá»£) hoáº·c máº·c Ä‘á»‹nh En
                        showAlternatives: true
                    }).addTo(map);

                    // Zoom báº£n Ä‘á»“ bao quÃ¡t cáº£ 2 Ä‘iá»ƒm
                    var bounds = L.latLngBounds([
                        [userLat, userLon],
                        [destLat, destLon]
                    ]);
                    map.fitBounds(bounds, {padding: [50, 50]});

                }, function(error) {
                    alert("Lá»—i: KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ cá»§a báº¡n. HÃ£y báº­t GPS trÃ¬nh duyá»‡t!");
                });
            } else {
                alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ GPS.");
            }
        };

        // Váº½ cÃ¡c Ä‘á»‹a Ä‘iá»ƒm lÃªn báº£n Ä‘á»“
        L.geoJSON(data, {
            onEachFeature: function (feature, layer) {
                // Láº¥y tá»a Ä‘á»™ Ä‘iá»ƒm Ä‘áº¿n (LÆ°u Ã½: GeoJSON lÃ  [Lon, Lat] cÃ²n Leaflet lÃ  [Lat, Lon])
                var lat = feature.geometry.coordinates[1];
                var lon = feature.geometry.coordinates[0];

                var popupContent = `
                    <h3>${feature.properties.name}</h3>
                    <p><b>Danh má»¥c:</b> ${feature.properties.category}</p>
                    <p><i>${feature.properties.description}</i></p>
                    <p>ğŸ“ ${feature.properties.address}</p>
                    <hr>
                    <button class="btn-route" onclick="startNavigation(${lat}, ${lon})">
                        ğŸš— Dáº«n Ä‘Æ°á»ng Ä‘áº¿n Ä‘Ã¢y
                    </button>
                    <br><br>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" style="color:blue; font-size: 0.9em;">
                        (Má»Ÿ báº±ng Google Maps)
                    </a>
                `;
                layer.bindPopup(popupContent);
            }
        }).addTo(map);

    </script>
</body>
</html>